/* angular-soil 1.1.2 %> */

(function(){var a={}.hasOwnProperty,b=function(b,c){function d(){this.constructor=b}for(var e in c)a.call(c,e)&&(b[e]=c[e]);return d.prototype=c.prototype,b.prototype=new d,b.__super__=c.prototype,b};angular.module("soil.association",["soil.collection"]).factory("HasOneAssociation",["$injector",function(a){var b;return b=function(){function b(b,c,d){this._field=b,null==d&&(d={}),this._options=_.defaults(d,{saveData:!1}),this._modelClass=a.get(c),this._idField=this._field+"_id"}return b.prototype.beforeLoad=function(a,b){return a?a[this._field]?a[this._field]=this._createModelInstance(b._scope,a[this._field],b):a[this._idField]?(a[this._field]=this._createModelInstance(b._scope,a[this._idField],b),delete a[this._idField]):void 0:void 0},b.prototype.beforeSave=function(a){var b;return a[this._field]?this._options.saveData?(b=a[this._field].id,a[this._field]=a[this._field].$dataToSave(),a[this._field].id=b):(a[this._idField]=a[this._field].id,delete a[this._field]):void 0===a[this._field]||this._options.saveData?void 0:(a[this._idField]=null,delete a[this._field])},b.prototype._createModelInstance=function(a,b,c){var d;return d=new this._modelClass(a,b),d._parent=c,d},b}()}]).factory("HasManyAssociation",["SoilCollection","$injector",function(a,c){var d;return d=function(){function d(a,b,d,e){this._field=a,this._idField=b,null==e&&(e={}),this._options=_.defaults(e,{saveData:!1,nestedUpdate:!1}),this._modelClass=c.get(d)}return d.prototype.beforeLoad=function(b,c){var d,e;if(b)return b[this._field]?(d=c.$url(b.id||c.id)+"/"+this._field,e=new a(c._scope,this._modelClassFor(d),d),b[this._field]=e.$load(b[this._field])):b[this._field]=new a(c._scope,this._modelClass),b[this._field]?b[this._field]._parent=c:void 0},d.prototype.beforeSave=function(a){return a[this._field]?this._options.saveData?a[this._field]=_.map(a[this._field].$members,function(a){return _.merge({id:a.id},a.$dataToSave())}):(a[this._idField]=_.map(a[this._field].$members,function(a){return a.id}),delete a[this._field]):void 0},d.prototype._modelClassFor=function(a){var c,d;return this._options.nestedUpdate?c=function(c){function e(){return d=e.__super__.constructor.apply(this,arguments)}return b(e,c),e.prototype._baseUrl=a,e}(this._modelClass):this._modelClass},d}()}])}).call(this),function(){var a={}.hasOwnProperty,b=function(b,c){function d(){this.constructor=b}for(var e in c)a.call(c,e)&&(b[e]=c[e]);return d.prototype=c.prototype,b.prototype=new d,b.__super__=c.prototype,b};angular.module("soil.collection",[]).factory("SoilCollection",["$http",function(a){var b;return b=function(){function b(a,b,c){this._scope=a,this.modelClass=b,this.sourceUrl=c,this.$members=[],this._scope&&this._setupListeners()}return b.prototype.$load=function(a){var b=this;return a||(a=[]),this.$members=_.map(a,function(a){return b._createModel(a)}),this},b.prototype.$get=function(){var b=this;return a.get(this.sourceUrl).success(function(a){return b.$load(a)})},b.prototype.$add=function(a){var b;return b=this._createModel(a),this.$members.push(b),b},b.prototype.$addToFront=function(a){var b;return b=this._createModel(a),this.$members.unshift(b),b},b.prototype.$addAt=function(a,b){var c;return c=this._createModel(b),this.$members.splice(a,0,c),c},b.prototype.$removeById=function(a){return _.remove(this.$members,function(b){return b.id===a})},b.prototype.$remove=function(a){return _.remove(this.$members,function(b){return a===b})},b.prototype.$find=function(a){return _.find(this.$members,function(b){return b.id===a})},b.prototype._setupListeners=function(){var a=this;return this._scope.$on("modelDeleted",function(b,c,d){return c===a.modelClass.prototype._modelType?a.$removeById(d):void 0})},b.prototype._createModel=function(a){var b;return b=new this.modelClass(this._scope,a),b.$setPostUrl(this.sourceUrl),this._parent&&(b._parent=this._parent),b},b}()}]).factory("SoilGlobalCollection",["SoilCollection","$rootScope",function(a,c){var d;return d=function(a){function d(a,b){d.__super__.constructor.call(this,c,a,b),this._setupCreateListener()}return b(d,a),d.prototype._setupCreateListener=function(){var a=this;return this._scope.$on("modelSaved",function(b,c,d){return c._modelType!==a.modelClass.prototype._modelType||_.any(a.$members,function(a){return a.id===c.id})?void 0:a.$add(d)})},d}(a)}])}.call(this),function(){angular.module("soil.model",[]).factory("SoilModel",["$http","$rootScope",function(a,b){var c;return c=function(){function c(a,b){this._scope=a,this._dataLoadedCallback=function(){},this.$saved={},angular.isObject(b)?this.$load(b):b?this.$get(b):this.$load({}),this._scope&&this._setupListeners()}return c.prototype._baseUrl="/",c.prototype._fieldsToSave=[],c.prototype._fieldsToSaveOnCreate=[],c.prototype._associations=[],c.prototype._modelType="model",c.prototype.$onDataLoaded=function(a){this._dataLoadedCallback=a},c.prototype.$setBaseUrl=function(a){return this._baseUrl=a},c.prototype.$setPostUrl=function(a){return this._postUrl=a},c.prototype.$url=function(a){return null==a&&(a=this.id),a?this._withSlash(this._baseUrl)+a:this._postUrl||this._baseUrl},c.prototype.$load=function(a){return this._clearFields(),this._setSavedData(a),_.assign(this,this._modifyDataBeforeLoad(a)),this._dataLoadedCallback(),this},c.prototype.$get=function(b){var c=this;return a.get(this.$url(b)).success(function(a){return c.$load(a)})},c.prototype.$save=function(){var c,d=this;return c=this.id?a.put:a.post,c(this.$url(),this.$dataToSave()).success(function(a){return d.$load(a),b.$broadcast("modelSaved",d,a)})},c.prototype.$delete=function(){var c=this;return this._checkIfLoaded(),a["delete"](this.$url()).success(function(){return b.$broadcast("modelDeleted",c._modelType,c.id),c.$load(null)})},c.prototype.$revert=function(){var a;return a=this.$saved,this._clearFields(),this._setSavedData(a),_.assign(this,this._modifyDataBeforeLoad(a)),this},c.prototype.$updateField=function(c){var d,e=this;return this._checkIfLoaded(),d={},d[c]=this[c],d=this._modifyDataBeforeSave(d),a.put(this.$url(),d).success(function(a){return e._loadField(c,a),b.$broadcast("modelFieldUpdated",e,c,a)}).error(function(){return e.$revertField(c)})},c.prototype.$revertField=function(a){var b;return b=this._modifyDataBeforeLoad(this.$saved),this[a]=b[a]},c.prototype.$dataToSave=function(){var a,b,c=this;return b=this._fieldsToSave,this.id||(b=b.concat(this._fieldsToSaveOnCreate)),a={},_.each(b,function(b){a[b]=void 0===c[b]?null:c[b]}),this._modifyDataBeforeSave(a)},c.prototype._loadField=function(a,b){var c;return this.$saved=_.cloneDeep(b),c=_.pick(b,a),c=this._modifyDataBeforeLoad(c),this[a]=c[a],this._dataLoadedCallback()},c.prototype._checkIfLoaded=function(){if(!this.id)throw"Operation not permitted on an unloaded model"},c.prototype._clearFields=function(){return _.forOwn(this,function(a,b,c){"_"===_.first(b)||angular.isFunction(a)||delete c[b]})},c.prototype._withSlash=function(a){return a.replace(/\/?$/,"/")},c.prototype._fieldsToSave=[],c.prototype._modifyDataBeforeLoad=function(a){var b,c=this;return b=_.clone(a),_.each(this._associations,function(a){a.beforeLoad(b,c)}),b},c.prototype._modifyDataBeforeSave=function(a){var b,c=this;return b=_.clone(a),_.each(this._associations,function(a){a.beforeSave(b,c)}),b},c.prototype._setSavedData=function(a){return this.$saved=a?_.cloneDeep(a):{}},c.prototype._setupListeners=function(){var a=this;return this._scope.$on("modelSaved",function(b,c,d){return a.id&&c._modelType===a._modelType&&c.id===a.id?a.$load(d):void 0}),this._scope.$on("modelFieldUpdated",function(b,c,d,e){return a.id&&c._modelType===a._modelType&&c.id===a.id?a._loadField(d,e):void 0})},c}()}])}.call(this);