/* angular-soil 1.5.5 %> */

(function(){var a={}.hasOwnProperty,b=function(b,c){function d(){this.constructor=b}for(var e in c)a.call(c,e)&&(b[e]=c[e]);return d.prototype=c.prototype,b.prototype=new d,b.__super__=c.prototype,b};angular.module("soil.association",["soil.collection"]).factory("HasOneAssociation",["$injector",function(a){var b;return b=function(){function b(b,c,d){this._field=b,null==d&&(d={}),this._options=_.defaults(d,{saveData:!1}),this._modelClass=a.get(c),this._idField=this._field+"_id"}return b.prototype.beforeLoad=function(a,b){return a?a[this._field]?a[this._field]=this._createModelInstance(b,a[this._field]):a[this._idField]?(a[this._field]=this._createModelInstance(b,a[this._idField]),delete a[this._idField]):void 0:void 0},b.prototype.beforeSave=function(a){var b;return a[this._field]?this._options.saveData?(b=a[this._field].id,a[this._field]=a[this._field].$dataToSave(),a[this._field].id=b):(a[this._idField]=a[this._field].id,delete a[this._field]):void 0===a[this._field]||this._options.saveData?void 0:(a[this._idField]=null,delete a[this._field])},b.prototype.setScope=function(a,b){return b[this._field]?b[this._field].$setScope(a):void 0},b.prototype._createModelInstance=function(a,b){var c;return c=new this._modelClass(a._scope,b),c._parent=a,c},b}()}]).factory("HasManyAssociation",["SoilCollection","$injector",function(a,c){var d;return d=function(){function d(a,b,d,e){this._field=a,this._idField=b,null==e&&(e={}),this._options=_.defaults(e,{saveData:!1,nestedUpdate:!1}),this._modelClass=c.get(d)}return d.prototype.beforeLoad=function(a,b){var c,d;if(a)return c=b.$url(a.slug||a.id||b.slug||b.id)+"/"+this._field,a[this._field]?(d=this._createCollection(b,this._modelClassFor(c),c),a[this._field]=d.$load(a[this._field])):a[this._field]=this._createCollection(b,this._modelClass,c)},d.prototype.beforeSave=function(a){return a[this._field]?this._options.saveData?a[this._field]=_.map(a[this._field].$members,function(a){return _.merge({id:a.id},a.$dataToSave())}):(a[this._idField]=_.map(a[this._field].$members,function(a){return a.id}),delete a[this._field]):void 0},d.prototype.setScope=function(a,b){return b[this._field]?b[this._field].$setScope(a):void 0},d.prototype._modelClassFor=function(a){var c;return this._options.nestedUpdate?c=function(c){function d(){return d.__super__.constructor.apply(this,arguments)}return b(d,c),d.prototype._baseUrl=a,d}(this._modelClass):this._modelClass},d.prototype._createCollection=function(b,c,d){var e;return e=new a(b._scope,c,d),e._parent=b,e},d}()}])}).call(this),function(){var a={}.hasOwnProperty,b=function(b,c){function d(){this.constructor=b}for(var e in c)a.call(c,e)&&(b[e]=c[e]);return d.prototype=c.prototype,b.prototype=new d,b.__super__=c.prototype,b};angular.module("soil.collection",[]).factory("SoilCollection",["$http","$q",function(a,b){var c;return c=function(){function c(a,c,d){this._scope=a,this.modelClass=c,this.sourceUrl=d,this.$members=[],this._initialLoad=b.defer(),this.$afterInitialLoad=this._initialLoad.promise,this._scope&&this._setupListeners()}return c.prototype.$load=function(a){return a||(a=[]),this.$members=_.map(a,function(a){return function(b){return a._createModel(b)}}(this)),this},c.prototype.$get=function(){return a.get(this.sourceUrl).success(function(a){return function(b){return a.$load(b),a._initialLoad.resolve()}}(this))},c.prototype.$add=function(a){var b;return b=this._createModel(a),this.$members.push(b),b},c.prototype.$addToFront=function(a){var b;return b=this._createModel(a),this.$members.unshift(b),b},c.prototype.$addAt=function(a,b){var c;return c=this._createModel(b),this.$members.splice(a,0,c),c},c.prototype.$removeById=function(a){return _.remove(this.$members,function(b){return b.id===a})},c.prototype.$remove=function(a){return _.remove(this.$members,function(b){return a===b})},c.prototype.$find=function(a){return _.find(this.$members,function(b){return b.id===a})},c.prototype.$setScope=function(a){if(this._scope)throw"Scope has already been set";return this._scope=a,this._setupListeners(),_.each(this.$members,function(){return function(b){b.$setScope(a)}}(this))},c.prototype._setupListeners=function(){return this._scope.$on("modelDeleted",function(a){return function(b,c,d){return c===a.modelClass.prototype._modelType?a.$removeById(d):void 0}}(this))},c.prototype._createModel=function(a){var b;return b=new this.modelClass(this._scope,a),b.$setPostUrl(this.sourceUrl),this._parent&&(b._parent=this._parent),b},c}()}]).factory("SoilGlobalCollection",["SoilCollection","$rootScope",function(a,c){var d;return d=function(a){function d(a,b){d.__super__.constructor.call(this,c,a,b),this._setupCreateListeners(),this.$afterInitialLoad.then(function(a){return function(){return a._loaded=!0}}(this)),this.$get()}return b(d,a),d.prototype._setupCreateListeners=function(){return this._scope.$on("modelSaved",function(a){return function(b,c,d){return c._modelType!==a.modelClass.prototype._modelType||_.any(a.$members,function(a){return a.id===c.id})?void 0:a.$add(d)}}(this)),this._scope.$on("modelCreateFailed",function(a){return function(b,c){return c._modelType===a.modelClass.prototype._modelType?a.$remove(c):void 0}}(this))},d}(a)}])}.call(this),function(){angular.module("soil.model",[]).factory("SoilModel",["$http","$rootScope",function(a,b){var c;return c=function(){function c(a,b){this._scope=a,this._dataLoadedCallback=function(){},this.$saved={},angular.isObject(b)?this.$load(b):b?this.$get(b):this.$load({}),this._scope&&this._setupListeners()}return c.prototype._baseUrl="/",c.prototype._fieldsToSave=[],c.prototype._fieldsToSaveOnCreate=[],c.prototype._associations=[],c.prototype._modelType="model",c.prototype._initializeFields=function(){},c.prototype.$onDataLoaded=function(a){this._dataLoadedCallback=a},c.prototype.$setBaseUrl=function(a){return this._baseUrl=a},c.prototype.$setPostUrl=function(a){return this._postUrl=a},c.prototype.$url=function(a){return a||(a=this.slug||this.id),a?this._withSlash(this._baseUrl)+a:this._postUrl||this._baseUrl},c.prototype.$load=function(a){return this._clearFields(),this._setSavedData(a),_.assign(this,this._modifyDataBeforeLoad(a)),this._dataLoadedCallback(),this},c.prototype.$get=function(b){return a.get(this.$url(b)).then(function(a){return function(b){return a.$load(b.data)}}(this))},c.prototype.$save=function(c){var d;return d=this.id?a.put:a.post,c||(c=this.$url()),d(c,this.$dataToSave()).success(function(a){return function(c){return a.$load(c),b.$broadcast("modelSaved",a,c)}}(this)).error(function(a){return function(){return a.id?void 0:b.$broadcast("modelCreateFailed",a)}}(this)).then(function(a){return function(){return a}}(this))},c.prototype.$delete=function(){return this.id?a["delete"](this.$url()).success(function(a){return function(){return b.$broadcast("modelDeleted",a._modelType,a.id),a.$load(null)}}(this)):b.$broadcast("modelCreateFailed",this)},c.prototype.$revert=function(){var a;return a=this.$saved,this._clearFields(),this._setSavedData(a),_.assign(this,this._modifyDataBeforeLoad(a)),this},c.prototype.$updateField=function(c){var d;return this._checkIfLoaded(),d={},d[c]=this[c],d=this._modifyDataBeforeSave(d),a.put(this.$url(),d).success(function(a){return function(d){return a._loadField(c,d),b.$broadcast("modelFieldUpdated",a,c,d)}}(this)).error(function(a){return function(){return a.$revertField(c)}}(this)).then(function(a){return function(){return a}}(this))},c.prototype.$revertField=function(a){var b;return b=this._modifyDataBeforeLoad(this.$saved),this[a]=b[a]},c.prototype.$dataToSave=function(){var a,b;return b=this._fieldsToSave,this.id||(b=b.concat(this._fieldsToSaveOnCreate)),a={},_.each(b,function(b){return function(c){a[c]=void 0===b[c]?null:b[c]}}(this)),this._modifyDataBeforeSave(a)},c.prototype.$setScope=function(a){if(this._scope)throw"Scope has already been set";return this._scope=a,this._setupListeners(),_.each(this._associations,function(b){return function(c){c.setScope(a,b)}}(this))},c.prototype._loadField=function(a,b){var c;return this.$saved=_.cloneDeep(b),c=_.pick(b,a),c=this._modifyDataBeforeLoad(c),this[a]=c[a],this._dataLoadedCallback()},c.prototype._checkIfLoaded=function(){if(!this.id)throw"Operation not permitted on an unloaded model"},c.prototype._clearFields=function(){return _.forOwn(this,function(a,b,c){"_"===_.first(b)||angular.isFunction(a)||delete c[b]}),this._initializeFields()},c.prototype._withSlash=function(a){return a.replace(/\/?$/,"/")},c.prototype._fieldsToSave=[],c.prototype._modifyDataBeforeLoad=function(a){var b;return b=_.clone(a),_.each(this._associations,function(a){return function(c){c.beforeLoad(b,a)}}(this)),b},c.prototype._modifyDataBeforeSave=function(a){var b;return b=_.clone(a),_.each(this._associations,function(a){return function(c){c.beforeSave(b,a)}}(this)),b},c.prototype._setSavedData=function(a){return this.$saved=a?_.cloneDeep(a):{}},c.prototype._setupListeners=function(){return this._scope.$on("modelSaved",function(a){return function(b,c,d){return a.id&&c!==a&&c._modelType===a._modelType&&c.id===a.id?a.$load(d):void 0}}(this)),this._scope.$on("modelFieldUpdated",function(a){return function(b,c,d,e){return a.id&&c!==a&&c._modelType===a._modelType&&c.id===a.id?a._loadField(d,e):void 0}}(this))},c}()}])}.call(this);